---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# missForestFast
`missForestFast` is a project for a case study for improving an existing 
random-forst-based method, [`missForest`](https://CRAN.R-project.org/package=missForest),
and added the ability to keep intermediate results
for further study the iterative imputation method.

## Accleration of random-forest-based methods
[`missForestFast`](https://github.com/shangzhi-hong/missForestFast)
provides user with the accelerated version of missing data imputation powered by
[`ranger`](https://CRAN.R-project.org/package=ranger) and [`randomForestSRC`](https://CRAN.R-project.org/package=randomForestSRC)

## Installation for development version from GitHub
Currently the `missForestFast` package is only available as source files on GitHub,
any interested user can install and test the `missForestFast` package by running
the following code in R:

``` r
if(!"remotes" %in% installed.packages()) install.packages("remotes")
remotes::install_github("shangzhi-hong/missForestFast")
```

Run example:
``` r
library(missForestFast)
data(iris)
set.seed(202003)
iris.mis <- prodNA(iris, noNA = 0.5)
impRanger <- missForestRanger(iris.mis, xtrue = iris, keepAll = TRUE)
impSrc <- missForestSrc(iris.mis, xtrue = iris, keepAll = TRUE)
```

## The auto-stop criterion
The auto-stop criterion used by original missForest algorithm may be misleading.
The original missForest algorithm stops the imputation once the out-of-bag error
increases, however, the increase can be instantaneous. As a fact, the symbolic
auto-stop criterion may just be a random stop from the continuous fluctuations
of the out-of-bag error estimates.

Example:
``` r
library(missForestFast)
data(iris)
set.seed(202003)
iris.mis <- prodNA(iris, noNA = 0.25)
targetIter <- 100
impRanger <- missForestRanger(iris.mis, xtrue = iris, maxiter = targetIter, keepAll = TRUE, forceIter = TRUE)
# Out-of-bag error (for auto-stop)
print(impRanger[["oobErrAll"]])
# Error from true data
print(impRanger[["errAll"]])
```

```{r PlotIterError, echo=FALSE, message=FALSE, warning=FALSE, out.width='50%', fig.align='center'}
library(ggplot2)
library(dplyr)
library(tidyr)
library(missForestFast)
data(iris)
set.seed(202003)
iris.mis <- prodNA(iris, noNA = 0.25)
targetIter <- 100
impRanger <- missForestRanger(iris.mis, xtrue = iris, maxiter = targetIter, keepAll = T, forceIter = T)
# Out-of-bag error (for auto-stop)
do.call(rbind, impRanger[["oobErrAll"]]) %>%
    as.data.frame() %>%
    mutate(Iteration = row_number()) %>%
    pivot_longer(c(NRMSE, PFC), names_to = "Type", values_to = "Value") %>%
    ggplot(aes(x = Iteration, y = Value, color = Type)) +
        geom_line() +
        theme_classic() +
        scale_colour_brewer(palette = "Set2") +
        ggtitle("OOB Error")
# Error from true value
do.call(rbind, impRanger[["errAll"]]) %>%
    as.data.frame() %>%
    mutate(Iteration = row_number()) %>%
    pivot_longer(c(NRMSE, PFC), names_to = "Type", values_to = "Value") %>%
    ggplot(aes(x = Iteration, y = Value, color = Type)) +
    geom_line() +
    theme_classic() +
    scale_colour_brewer(palette = "Set2") +
    ggtitle("Error from True Value")
```


## The initialization of the imputation
In our opinion, the missForest algorithm should be recognized as a special case
of MICE (Multivariate Imputation using Chained Equations), using predicted means
as a replacement of samples from conditional distributions.
Use of variable mean (for continuous variable) and most frequent category (for
categorical variable) may not be the best choice.

Example:
``` r
library(missForestFast)
data(iris)
set.seed(202003)
iris.mis <- prodNA(iris, noNA = 0.25)
targetIter <- 100
impRangerMean <- missForestRanger(iris.mis, xtrue = iris, maxiter = targetIter, keepAll = TRUE, forceIter = TRUE, randInit = FALSE)
# Out-of-bag error with original initialization
print(impRangerMean[["oobErrAll"]])
# Error from true data with original initialization
print(impRangerMean[["errAll"]])
impRangerRand <- missForestRanger(iris.mis, xtrue = iris, maxiter = targetIter, keepAll = TRUE, forceIter = TRUE, randInit = TRUE)
# Out-of-bag error with random initialization
print(impRangerRand[["oobErrAll"]])
# Error from true data with random initialization
print(impRangerRand[["errAll"]])
```

```{r Init, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, out.width='50%'}
library(ggplot2)
library(dplyr)
library(tidyr)
library(missForestFast)
data(iris)
set.seed(2020)
iris.mis <- prodNA(iris, noNA = 0.20)
targetIter <- 100
impRangerMean <-
    missForestRanger(
        iris.mis,
        xtrue = iris,
        maxiter = targetIter,
        keepAll = TRUE,
        forceIter = TRUE,
        randInit = FALSE
    )
resOobMean <- do.call(rbind, impRangerMean[["oobErrAll"]]) %>%
    as.data.frame() %>%
    mutate(Iteration = row_number()) %>%
    pivot_longer(c(NRMSE, PFC), names_to = "Type", values_to = "Value") %>%
    mutate(Initialization = "Mean")
resTrueMean <- do.call(rbind, impRangerMean[["errAll"]]) %>%
    as.data.frame() %>%
    mutate(Iteration = row_number()) %>%
    pivot_longer(c(NRMSE, PFC), names_to = "Type", values_to = "Value") %>%
    mutate(Initialization = "Mean")
impRangerRand <-
    missForestRanger(
        iris.mis,
        xtrue = iris,
        maxiter = targetIter,
        keepAll = TRUE,
        forceIter = TRUE,
        randInit = TRUE
    )
resOobRand <- do.call(rbind, impRangerRand[["oobErrAll"]]) %>%
    as.data.frame() %>%
    mutate(Iteration = row_number()) %>%
    pivot_longer(c(NRMSE, PFC), names_to = "Type", values_to = "Value") %>%
    mutate(Initialization = "Random")
resTrueRand <- do.call(rbind, impRangerRand[["errAll"]]) %>%
    as.data.frame() %>%
    mutate(Iteration = row_number()) %>%
    pivot_longer(c(NRMSE, PFC), names_to = "Type", values_to = "Value") %>%
    mutate(Initialization = "Random")
bind_rows(resOobMean, resOobRand) %>%
    mutate(Type = paste0(Initialization, "_", Type)) %>%
    ggplot(aes(x = Iteration, y = Value, color = Type)) +
    geom_line() +
    theme_classic() +
    ggtitle("Initialization - OOB Error")

bind_rows(resTrueMean, resTrueRand) %>%
    mutate(Type = paste0(Initialization, "_", Type)) %>%
    ggplot(aes(x = Iteration, y = Value, color = Type)) +
    geom_line() +
    theme_classic() +
    ggtitle("Initialization - True Error")

```
